# 🔧 PLC 통신 디버깅 가이드

이 가이드는 PLC로부터 데이터를 추출하는 명령을 전송하고 응답을 콘솔에서 확인하는 방법을 설명합니다.

## ⚡ 프로토콜 감지 (중요!)

오빠의 PLC는 **Modbus TCP** 프로토콜을 사용합니다! 🎯

| 프로토콜 | 포트 | 사용 |
|---------|------|------|
| 🔌 MC Protocol (Mitsubishi) | 2000 | 아니오 |
| 📡 **Modbus TCP (LS 등)** | **502** | **✅ 현재 시스템** |

**현재 PLC 주소: 192.168.111.186:502**

---

## 📚 목차

1. [빠른 시작](#빠른-시작)
2. [Modbus TCP 스크립트](#modbus-tcp-스크립트)
3. [MC Protocol 스크립트](#mc-protocol-스크립트)
4. [라이브 폴링 확인](#라이브-폴링-확인)
5. [콘솔 출력 예시](#콘솔-출력-예시)
6. [문제 해결](#문제-해결)

---

## 🚀 빠른 시작

### 🎯 **Modbus TCP 디버거** (당신의 PLC용!)

```bash
# 기본값 (127.0.0.1:502, Slave ID 1, D400 D430)
npm run debug:modbus

# 특정 IP와 포트로 실행
npm run debug:modbus 192.168.111.186 502

# Slave ID와 주소 지정
npm run debug:modbus 192.168.111.186 502 1 D400 D410 D420

# 여러 주소 읽기
npm run debug:modbus 192.168.111.186 502 1 D400 D410 D420 D430 D4000
```

### 🔌 **MC Protocol 디버거** (Mitsubishi용)

```bash
# 기본값 (127.0.0.1:2000)
npm run debug:plc

# 특정 IP와 포트
npm run debug:plc 192.168.0.1 2000

# 특정 주소
npm run debug:plc 192.168.0.1 2000 D400,1 D430,1
```

---

## 📝 Modbus TCP 스크립트

### 파일 위치
```
d:\Project\OhSung Monitoring\debug-modbus.js
```

### 커맨드라인 인자

```bash
npm run debug:modbus [IP] [PORT] [SLAVE_ID] [ADDRESS1] [ADDRESS2] ...
```

| 인자 | 설명 | 기본값 |
|------|------|--------|
| `[IP]` | PLC IP 주소 | `127.0.0.1` |
| `[PORT]` | Modbus 포트 | `502` |
| `[SLAVE_ID]` | Modbus Slave ID | `1` |
| `[ADDRESS]` | 읽을 주소 (D400 등) | `D400 D430` |

### 주소 형식

- `D400` → D400 주소의 값 읽기
- `D430` → D430 주소의 값 읽기
- `D4000` → D4000 주소의 값 읽기

### 실행 예시

```bash
# 1개 주소 읽기
npm run debug:modbus 192.168.111.186 502 1 D400

# 여러 주소 읽기
npm run debug:modbus 192.168.111.186 502 1 D400 D410 D420 D430

# 전력 데이터도 함께 읽기
npm run debug:modbus 192.168.111.186 502 1 D400 D430 D4000 D4010
```

---

## 📝 MC Protocol 스크립트

### 파일 위치
```
d:\Project\OhSung Monitoring\debug-plc.js
```

### 커맨드라인 인자

```bash
npm run debug:plc [IP] [PORT] [ADDRESS1] [ADDRESS2] ...
```

| 인자 | 설명 | 기본값 |
|------|------|--------|
| `[IP]` | PLC IP 주소 | `127.0.0.1` |
| `[PORT]` | MC Protocol 포트 | `2000` |
| `[ADDRESS]` | 읽을 주소 | `D400,1 D430,1` |

### 주소 형식

- `D430,1` → D430부터 1개 값 읽기
- `D430` → D430 주소 (자동으로 1로 처리)
- `D400,3` → D400부터 3개 값 읽기

---

## 📊 라이브 폴링 확인

애플리케이션 실행 중에도 PLC 응답을 콘솔에서 확인할 수 있습니다.

### 1️⃣ **개발 서버 실행**

```bash
npm run dev
```

### 2️⃣ **모니터링 페이지 방문**

```
http://localhost:3002/monitoring
```

### 3️⃣ **콘솔 확인**

서버 로그에서 다음과 같은 메시지를 볼 수 있습니다:

```
──────────────────────────────────────────────────────────────────────
📊 [폴링 09:30:45]
──────────────────────────────────────────────────────────────────────
📍 주소별 값:
   D400: 0
   D430: 0
   D4000: 0
──────────────────────────────────────────────────────────────────────
```

---

## 🖨️ 콘솔 출력 예시

### ✅ Modbus TCP 성공 케이스

```
══════════════════════════════════════════════════════════════════════
🔧 Modbus TCP PLC 디버거
══════════════════════════════════════════════════════════════════════
📡 IP: 192.168.111.186:502
🆔 Slave ID: 1
📍 읽을 주소 (4개):
   1. D400
   2. D410
   3. D420
   4. D430
══════════════════════════════════════════════════════════════════════

⏳ Modbus TCP 연결 시도 중...
   192.168.111.186:502
✅ Modbus TCP 연결 성공!

⏳ 데이터 읽기 시도 중...
   주소: D400, D410, D420, D430

📊 읽기 명령:
   📍 D400 (레지스터 400) 읽는 중...
      ✅ 값: 0
   📍 D410 (레지스터 410) 읽는 중...
      ✅ 값: 0
   📍 D420 (레지스터 420) 읽는 중...
      ✅ 값: 0
   📍 D430 (레지스터 430) 읽는 중...
      ✅ 값: 0

──────────────────────────────────────────────────────────────────────
✅ 읽기 완료!
──────────────────────────────────────────────────────────────────────

📊 결과 데이터:
{
  "D400": 0,
  "D410": 0,
  "D420": 0,
  "D430": 0
}

📊 주소별 값:
┌─────────────┬──────────────┐
│ 주소        │ 값           │
├─────────────┼──────────────┤
│ D400        │ 0            │
│ D410        │ 0            │
│ D420        │ 0            │
│ D430        │ 0            │
└─────────────┴──────────────┘

💾 추가 정보:
   읽기 성공: 4/4

👋 Modbus 연결 종료

══════════════════════════════════════════════════════════════════════
✨ 디버깅 완료
```

### ✅ MC Protocol 성공 케이스

```
======================================================================
🔧 PLC 통신 디버거 (MC Protocol)
======================================================================
📡 IP: 192.168.0.1:2000
📍 읽을 주소 (3개):
   1. D400,1
   2. D430,1
   3. D4000,1
======================================================================

⏳ PLC 연결 시도 중...
   192.168.0.1:2000

🔌 PLC 연결 시도 중...
   IP: 192.168.0.1, 포트: 2000
======================================================================
✅ PLC 연결 성공! (192.168.0.1:2000)
======================================================================

⏳ 데이터 읽기 명령 전송 중...
   주소: D400,1, D430,1, D4000,1

======================================================================
✅ PLC 응답 수신!
======================================================================
📋 요청한 주소:
   1. D400,1
   2. D430,1
   3. D4000,1

📊 PLC 응답 데이터:
{
  "D400,1": 45,
  "D430,1": 38,
  "D4000,1": 220
}

📈 파싱된 결과:
   D400,1: 45
   D430,1: 38
   D4000,1: 220
======================================================================

👋 PLC 연결 종료

======================================================================
✨ 디버깅 완료
```

### ❌ 연결 실패 케이스

```
══════════════════════════════════════════════════════════════════════
🔧 Modbus TCP PLC 디버거
══════════════════════════════════════════════════════════════════════
📡 IP: 192.168.0.100:502
🆔 Slave ID: 1
📍 읽을 주소 (1개):
   1. D400
══════════════════════════════════════════════════════════════════════

⏳ Modbus TCP 연결 시도 중...
   192.168.0.100:502

❌ 연결 실패!
   에러: connect ECONNREFUSED 192.168.0.100:502
   코드: ECONNREFUSED

💥 에러 발생: connect ECONNREFUSED 192.168.0.100:502

══════════════════════════════════════════════════════════════════════
✨ 디버깅 완료
```

---

## 🚨 문제 해결

### 1️⃣ **"ECONNREFUSED" 에러**

PLC가 꺼져있거나 네트워크 연결이 끊어진 경우입니다.

```bash
# PLC IP/PORT 확인
npm run debug:modbus 192.168.111.186 502

# 네트워크 연결 테스트 (Windows)
ping 192.168.111.186

# 포트 열려있는지 확인
netstat -an | findstr 502
```

### 2️⃣ **"ENOTFOUND" 에러**

IP 주소가 잘못되었거나 DNS 문제입니다.

```bash
# IP 주소 확인
npm run debug:modbus 192.168.111.186 502

# 방화벽 설정 확인
```

### 3️⃣ **레지스터 매핑 오류**

D400 주소가 레지스터 400으로 변환되어 읽혀집니다.
실제 PLC 메뉴얼을 확인하여 주소-레지스터 매핑을 조정하세요.

```javascript
// debug-modbus.js에서 addressToRegister 함수 수정
addressToRegister(address) {
  const match = address.match(/D(\d+)/);
  if (!match) throw new Error(`Invalid address format: ${address}`);
  const dAddress = parseInt(match[1]);
  // 여기서 변환 로직 수정 (예: D400 → 레지스터 0)
  return dAddress;
}
```

### 4️⃣ **콘솔 로그가 안 보일 때**

개발 서버를 포그라운드에서 실행하고 있는지 확인하세요:

```bash
# ✅ 올바른 방법
npm run dev

# 그 후 별도 터미널에서:
npm run debug:modbus 192.168.111.186 502 1 D400
```

---

## 📖 추가 정보

### 수정된 파일들

1. **[src/lib/mc-plc.ts](src/lib/mc-plc.ts)**
   - PLC 연결, 읽기, 쓰기 시 상세 로깅 추가

2. **[src/lib/realtime-data-service.ts](src/lib/realtime-data-service.ts)**
   - 폴링 시 주소별 값 상세 로깅

3. **[debug-plc.js](debug-plc.js)** (신규)
   - MC Protocol 디버거 (Node.js)

4. **[debug-modbus.js](debug-modbus.js)** (신규 - 현재 사용!)
   - Modbus TCP 디버거 (Node.js)

5. **[package.json](package.json)**
   - `npm run debug:plc` 스크립트 추가
   - `npm run debug:modbus` 스크립트 추가

---

## 💡 자주 사용하는 명령

```bash
# 현재 PLC (Modbus TCP)
npm run debug:modbus 192.168.111.186 502 1 D400

# 여러 온도센서
npm run debug:modbus 192.168.111.186 502 1 D400 D410 D420 D430 D440 D450

# 전력 데이터
npm run debug:modbus 192.168.111.186 502 1 D4000 D4010 D4020

# 모두 함께
npm run debug:modbus 192.168.111.186 502 1 D400 D410 D420 D430 D4000 D4010
```

---

**마지막 업데이트**: 2025년 12월 - Modbus TCP 프로토콜 지원 추가
