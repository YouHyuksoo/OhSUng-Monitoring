# 📍 PC 주소 매핑 가이드

PLC 원본 주소에서 PC(Modbus) 주소로의 변환 매핑입니다.

## 🎯 주소 변환 테이블

### 온도 센서 데이터

#### 수절 건조로 (현재값 + 설정값)

| Word | PLC 원본 | PC (Modbus) | 설명 | 타입 |
|------|---------|------------|------|------|
| 1 | **D400** | **D6050** | 수절 1 (현재값) | 온도 |
| - | D401 | D6060 | 수절 1 (설정값) | 온도 |
| 2 | **D410** | **D6051** | 수절 2 (현재값) | 온도 |
| - | D411 | D6061 | 수절 2 (설정값) | 온도 |
| 3 | **D420** | **D6052** | 수절 3 (현재값) | 온도 |
| - | D421 | D6062 | 수절 3 (설정값) | 온도 |

#### 열풍 건조로 (현재값 + 설정값)

| Word | PLC 원본 | PC (Modbus) | 설명 | 타입 |
|------|---------|------------|------|------|
| 4 | **D430** | **D6053** | 열풍 1 (현재값) | 온도 |
| - | D431 | D6063 | 열풍 1 (설정값) | 온도 |
| 5 | **D440** | **D6054** | 열풍 2 (현재값) | 온도 |
| - | D441 | D6064 | 열풍 2 (설정값) | 온도 |
| 6 | **D450** | **D6055** | 열풍 3 (현재값) | 온도 |
| - | D451 | D6065 | 열풍 3 (설정값) | 온도 |
| 7 | **D460** | **D6056** | 열풍 4 (현재값) | 온도 |
| - | D461 | D6066 | 열풍 4 (설정값) | 온도 |
| 8 | **D470** | **D6057** | 열풍 5 (현재값) | 온도 |
| - | D471 | D6067 | 열풍 5 (설정값) | 온도 |

### 전력 데이터

| 항목 | PLC 원본 | PC (Modbus) | 설명 |
|------|---------|------------|------|
| 전력 | **D4032** | **D6050** | 순방향 유효전력량 |
| 누적 | - | D6100 | 누적 전력량 |

---

## 📊 매핑 패턴 분석

### 온도 센서 (현재값)

**PLC → PC 변환식:**
```
온도 센서 현재값 = (PLC 주소 - 400) / 10 + 6050

예시:
D400 → D6050  (센서 1)
D410 → D6051  (센서 2)
D420 → D6052  (센서 3)
D430 → D6053  (센서 4)
D440 → D6054  (센서 5)
D450 → D6055  (센서 6)
D460 → D6056  (센서 7)
D470 → D6057  (센서 8)
```

**패턴:**
- **기본:** D4XX (온도 센서) → D605X (PC)
- **오프셋:** (PLC번호 - 400) / 10 = PC 십의 자리
- **베이스:** 6050부터 시작

### 온도 센서 (설정값)

**PLC → PC 변환식:**
```
온도 센서 설정값 = (PLC 주소 - 401) / 10 + 6060

예시:
D401 → D6060  (센서 1 설정값)
D411 → D6061  (센서 2 설정값)
D421 → D6062  (센서 3 설정값)
D431 → D6063  (센서 4 설정값)
D441 → D6064  (센서 5 설정값)
D451 → D6065  (센서 6 설정값)
D461 → D6066  (센서 7 설정값)
D471 → D6067  (센서 8 설정값)
```

**패턴:**
- **기본:** D4X1 (온도 설정값) → D606X (PC)
- **오프셋:** (PLC번호 - 401) / 10 = PC 십의 자리
- **베이스:** 6060부터 시작

---

## 🔄 변환 프로세스

### 현재 설정 (settings-store.ts)

```typescript
chartConfigs: [
  // 수절 1 (현재값)
  {
    id: "sujul-1",
    name: "수절 1 (현재값)",
    type: "sujul",
    address: "D6050",      // PC 주소 ✅
    setAddress: "D6060",   // PC 설정값 주소 ✅
  },
  // 수절 2 (현재값)
  {
    id: "sujul-2",
    name: "수절 2 (현재값)",
    type: "sujul",
    address: "D6051",      // PC 주소 ✅
    setAddress: "D6061",   // PC 설정값 주소 ✅
  },
  // ... 등등
]
```

### 디버거 실행 (debug-modbus.js)

```bash
# D6050 (수절 1 현재값) 읽기
npm run debug:modbus 192.168.111.186 502 1 D6050

# D6051, D6052 (수절 2, 3 현재값) 읽기
npm run debug:modbus 192.168.111.186 502 1 D6051 D6052

# 모든 온도 센서 읽기
npm run debug:modbus 192.168.111.186 502 1 D6050 D6051 D6052 D6053 D6054 D6055 D6056 D6057
```

### Modbus 변환 (debug-modbus.js의 addressToRegister)

```javascript
addressToRegister("D6050")
  → match[1] = "6050"
  → parseInt("6050") = 6050
  → return 6050  // 레지스터 6050 접근
```

### PLC에서 응답

```
Modbus FC03: 레지스터 6050을 1개 읽어줘
PLC 메모리: 레지스터 6050 = 45 (°C)
응답: { "D6050": 45 }
```

---

## ✅ 현재 설정 상태

### settings-store.ts (src/lib/settings-store.ts)

**상태:** ✅ **업데이트 완료**

**변경 사항:**
```
❌ D400 → ✅ D6050 (수절 1 현재값)
❌ D401 → ✅ D6060 (수절 1 설정값)
❌ D410 → ✅ D6051 (수절 2 현재값)
❌ D411 → ✅ D6061 (수절 2 설정값)
... (모든 주소 변환 완료)
❌ D4032 → ✅ D6050 (전력 데이터)
```

### debug-modbus.js

**상태:** ✅ **업데이트 완료**

**변경 사항:**
```javascript
// 이전: D400 → 레지스터 400
// 현재: D6050 → 레지스터 6050 ✅ (PC 주소 기준)
```

---

## 🎯 테스트 명령

### 수절 1 (현재값 + 설정값)
```bash
npm run debug:modbus 192.168.111.186 502 1 D6050 D6060
```

**예상 응답:**
```
📊 결과 데이터:
{
  "D6050": 45,    ← 수절 1 현재값 (°C)
  "D6060": 50     ← 수절 1 설정값 (°C)
}
```

### 열풍 센서 모두
```bash
npm run debug:modbus 192.168.111.186 502 1 D6053 D6054 D6055 D6056 D6057
```

**예상 응답:**
```
📊 결과 데이터:
{
  "D6053": 55,    ← 열풍 1
  "D6054": 56,    ← 열풍 2
  "D6055": 54,    ← 열풍 3
  "D6056": 57,    ← 열풍 4
  "D6057": 55     ← 열풍 5
}
```

---

## 🔍 변환 검증

### 1️⃣ 주소 확인
```javascript
// PC 주소가 올바른지 확인
D6050, D6051, D6052, D6053, ... ✅
D6060, D6061, D6062, D6063, ... ✅
```

### 2️⃣ 정규식 추출
```javascript
"D6050".match(/D(\d+)/)
// → ["D6050", "6050"] ✅
```

### 3️⃣ 레지스터 변환
```javascript
parseInt("6050", 10)
// → 6050 (레지스터 6050) ✅
```

### 4️⃣ PLC에서 읽기
```
레지스터 6050의 값을 읽어줘
→ PLC 응답: 45
→ 프로젝트에서 수신: { "D6050": 45 }
```

---

## 📋 주소 매핑 체크리스트

모니터링 페이지(`/monitoring`)에서:

- [ ] 수절 1 차트가 올바른 데이터 표시
- [ ] 수절 2 차트가 올바른 데이터 표시
- [ ] 수절 3 차트가 올바른 데이터 표시
- [ ] 열풍 1~5 차트가 올바른 데이터 표시
- [ ] 설정값(노란색)과 현재값(주황색)이 다름
- [ ] 전력 데이터 표시 정상

---

## 🔧 문제 해결

### 문제: 모든 차트에 0만 표시

**원인:** PC 주소의 레지스터에 데이터가 없음

**해결책:**
```bash
# PLC 메뉴얼 확인
# 1. D6050 주소가 실제 데이터를 포함하는지 확인
# 2. Modbus 레지스터 맵 확인
# 3. PC가 실제로 데이터를 쓰고 있는지 확인

# 테스트
npm run debug:modbus 192.168.111.186 502 1 D6050
```

### 문제: 특정 주소만 실패

**원인:** 해당 주소가 PC에 매핑되지 않음

**해결책:**
1. 이미지의 매핑 테이블 다시 확인
2. PC 주소가 정확한지 확인
3. 현재 설정과 일치하는지 확인

---

## 📚 참고자료

### 이미지 기준 매핑

**상단 표:** 온도 센서 (현재값)
- PLC D400~D470 → PC D6050~D6057

**하단 표:** 온도 센서 (설정값)
- PLC D401~D471 → PC D6060~D6067

### 프로젝트 파일

- **설정:** [src/lib/settings-store.ts](src/lib/settings-store.ts)
- **디버거:** [debug-modbus.js](debug-modbus.js)
- **모니터링:** [src/app/monitoring/page.tsx](src/app/monitoring/page.tsx)

---

**마지막 업데이트:** 2025년 12월

**현재 상태:** ✅ PC 주소 기준으로 완전히 변환됨
